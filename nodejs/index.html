<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
  <script type="text/javascript" src="http://craftyjs.com/release/0.4.2/crafty.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <title>Asteroids</title>
  <style>
  body, html { margin:0; padding: 0; overflow:hidden; font-family:Arial; font-size:20px }
  </style>
</head>
<body>

  <script type="text/javascript">
  $(document).ready(function() {

    var socket = io();

    var client_id = -1;
    socket.on('client_id', function (id) {
      console.log(id);
      client_id = id;
    });

  //init Crafty with FPS of 50 and create the canvas element
  Crafty.init();
  Crafty.canvas();
  
  //preload the needed assets
  Crafty.load(["http://craftyjs.com/demos/asteroids/images/sprite.png", "http://craftyjs.com/demos/asteroids/images/bg.png"], function() {
    //splice the spritemap
    Crafty.sprite(64, "http://craftyjs.com/demos/asteroids/images/sprite.png", {
      ship: [0,0],
      big: [1,0],
      medium: [2,0],
      small: [3,0]
    });
    
    //start the main scene when loaded
    Crafty.scene("main");
  });
  
  Crafty.scene("main", function() {
    Crafty.background("url('http://craftyjs.com/demos/asteroids/images/bg.png')");
    
    //score display
    var score = Crafty.e("2D, DOM, Text")
    .text("Score: 0")
    .attr({x: Crafty.viewport.width - 300, y: Crafty.viewport.height - 50, w: 200, h:50})
    .css({color: "#fff"});

    //player entity
    var player = Crafty.e("2D, Canvas, ship, Controls, Collision")
    .attr({move: {left: false, right: false, up: false, down: false}, xspeed: 0, yspeed: 0, decay: 0.9, 
      x: Crafty.viewport.width / 2, y: Crafty.viewport.height / 2, score: 0})
    .origin("center")
    .bind("keydown", function(e) {
        //on keydown, set the move booleans
        if(e.keyCode === Crafty.keys.RIGHT_ARROW) {
          this.move.right = true;
        } else if(e.keyCode === Crafty.keys.LEFT_ARROW) {
          this.move.left = true;
        } else if(e.keyCode === Crafty.keys.UP_ARROW) {
          this.move.up = true;
        } 
      }).bind("keyup", function(e) {
        //on key up, set the move booleans to false
        if(e.keyCode === Crafty.keys.RIGHT_ARROW) {
          this.move.right = false;
        } else if(e.keyCode === Crafty.keys.LEFT_ARROW) {
          this.move.left = false;
        } else if(e.keyCode === Crafty.keys.UP_ARROW) {
          this.move.up = false;
        }
      }).bind("enterframe", function() {
        if(this.move.right) this.rotation += 5;
        if(this.move.left) this.rotation -= 5;
        
        //acceleration and movement vector
        var vx = Math.sin(this._rotation * Math.PI / 180) * 0.3,
        vy = Math.cos(this._rotation * Math.PI / 180) * 0.3;
        
        //if the move up is true, increment the y/xspeeds
        if(this.move.up) {
          this.yspeed -= vy;
          this.xspeed += vx;
        } else {
          //if released, slow down the ship
          this.xspeed *= this.decay;
          this.yspeed *= this.decay;
        }

        //if ship goes out of bounds, put him back
        if(this._x > Crafty.viewport.width) {
          this.x = -64;
        }
        if(this._x < -64) {
          this.x =  Crafty.viewport.width;
        }
        if(this._y > Crafty.viewport.height) {
          this.y = -64;
        }
        if(this._y < -64) {
          this.y = Crafty.viewport.height;
        }

        socket.emit('position', {x: this.x + this.xspeed, y: this.y + this.yspeed, rotation: this.rotation});
        
      });


  var remotePlayer = Crafty.e("2D, Canvas, ship, Controls, Collision")
  .attr({x: 10, y: 10})
  .origin("center").bind("enterframe", function() {});

  socket.on('players_positions', function (positions) {
    Object.keys(positions).forEach(function (id) { 
      if(id == client_id) {
          player.x = positions[client_id]['x'];
          player.y = positions[client_id]['y'];
          player.rotation = positions[client_id]['rotation'];
      } else {
        remotePlayer.x = positions[id]['x'];
        remotePlayer.y = positions[id]['y'];
        remotePlayer.rotation = positions[id]['rotation'];      
      }
    });
  });

});

});
  </script>

</body>
</html>